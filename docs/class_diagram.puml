@startuml

package ch.zucchinit.zauction {
    class SpringApplication
    class ZAuctionApplication {
        +main(String[]): void
    }
    "ZAuctionApplication" --> "SpringApplication"

    package Auth {
        interface UserRepository<extends JARepository<User, Long>>{
            findByEmail(String email): User
            existsByEmail(String email): boolean
        }
        interface TokenRepository<extends JARepository<Token, Long>>{
            deleteByExpireDateBefore(DateTime: date): void
        }
        class AuthDTO
        class AuthController {
            -userService: UserService
            -tokenService: TokenService
            +register(AuthDTO.UserRegister register): AuthDTO.UserProfile
            +login(AuthDTO.UserLogin login): AuthDTO.UserProfile
            +unregister(): void
            +me(): AuthDTO.UserProfile
            +getAccount(): AuthDTO.UserAccount
            +updateAccount(AuthDTO.UserAccount userAccount): AuthDTO.UserAccount
            +resetPassword(AuthDTO.UserResetPassword userResetPassword): void
        }
        class UserService {
            -userRepository: UserRepository
            -passwordEncoder: BCryptPasswordEncoder
            +getUserFromContext(): User
            +getUserProfile(User user): AuthDTO.UserProfile
            +getUserAccount(User user): AuthDTO.UserAccount
            +findUserByEmailAndPassword(String email, String password): User
            +createUser(AuthDTO.UserRegister register): User
            +updateUser(AuthDTO.UserAccount userAccount): AuthDTO.UserAccount
            +resetPassword(AuthDTO.UserResetPassword userResetPassword): void
        }
        class TokenService {
            +tokenMinutesValidity: Integer
            -tokenRepository: TokenRepository
            +getCookieToken(String tokenValue): Cookie
            +extractCookieToken(Cookie[] cookies): Cookie
            +deleteCookieToken(): Cookie
            +registerToken(User user): void
            +findTokenById(String tokenValue): Token
            +unregisterToken(Token token): void
            +purgeExpiredTokens(): void
        }

        "AuthController" --> "UserService"
        "AuthController" --> "TokenService"
        "UserService" --> "UserRepository"
        "TokenService" --> "TokenRepository"
    }

    package Category {
        interface CategoryRepository<extends JARepository<Category, Long>> {
            -findByParentIsNull: Category[]
        }
        class CategoryController {
            -categoryService: CategoryService
            +all(): Category[]
        }
        class CategoryService {
            -categoryRepository: CategoryRepository
            +findAll(): Category[]
            +getChildIds(Category category, Long ids[]): Long[]
            +getReverseCategories(Long categoryId): Category[]
        }

        "CategoryController" --> "CategoryService"
        "CategoryService" --> "CategoryRepository"
    }

    package Lot {
        interface LotRepository<extends JARepository<Lot, Long>>
        class LotDTO
        class LotController {
            -lotService: LotService
            +paginate(Integer page, Integer take, Category category, String search): LotDTO.LotPaginatedThumbnail
            +one(Long id): LotDTO.LotDetails
        }
        class LotService {
            -lotRepository: LotRepository
            -categoryService: CategoryService
            +findByPageWithCategoryAndSearch(Integer page, Integer take, Category category, String search): LotDTO.LotPaginatedThumbnail
            +findById(Long id): LotDTO.LotDetails
            {static} isFinished() : Specification<Lot>
            -hasCategoryId(Long id) : Specification<Lot>
            {static} multiFieldSearch(String keyword) : Specification<Lot>
        }

        "LotController" --> "LotService"
        "LotService" --> "LotRepository"
    }

    package Auction {
        interface AuctionRepository<extends JARepository<Auction, Long>>
   }

    package Exceptions {
        exception "ResourceNotFound"
        exception "NotAuthorized"
        class "ExceptionsDTO" {}
        class ExceptionsAdvice {
            +userNotAuthorizedHandler: void
            +resourceNotFoundHandler: void
            +validationErrorHandler : ExceptionsDTO
            +unknownErrorHandler: ExceptionsDTO
        }

        "ResourceNotFound" --> "ExceptionsAdvice"
        "NotAuthorized" --> "ExceptionsAdvice"
        "ExceptionsDTO" --> "ExceptionsAdvice"
    }

    package Security {
        class SecurityConfig {
            -corsConfigurationSource: CorsConfigurationSource
            +securityFilterChain: SecurityFilterChain
        }

        class TokenAuthenticationFilter {
            {static} authCookieName: String
            -tokenService: TokenService
            #doFilterInternal(): void
        }
    }

    class S3Connector {
        -s3client: s3Client
        +uploadMedias(Long id)
        +getUrls(Long id): String[]
    }
    "LotService" --> "S3Connector"
}

@enduml